<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANALYST PRO - EXPORT & RECORD</title>
    <style>
        :root { --bg: #020205; --panel: #0b0b15; --cyan: #00f2ff; --neon: #39ff14; --border: #1a1a2e; --warning: #ffcc00; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; overflow: hidden; }
        .main-container { display: flex; width: 100%; height: 97vh; gap: 10px; }
        .sidebar { width: 320px; background: var(--panel); padding: 15px; border-radius: 12px; border: 1px solid var(--border); overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .map-wrapper { flex: 1; position: relative; background: #000; border: 2px solid #111; overflow: hidden; border-radius: 8px; }
        #map-area { width: 100%; height: 100%; background-size: contain; background-repeat: no-repeat; background-position: center; position: relative; cursor: crosshair; }
        #map-darkener { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); pointer-events: none; z-index: 1; }
        canvas { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; }
        #c-heat { z-index: 2; mix-blend-mode: screen; } 
        #c-lines { z-index: 3; }
        #p-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 10; pointer-events: none; }
        .control-box { background: #121225; padding: 10px; border-radius: 8px; border: 1px solid #1d1d3d; }
        button { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 10px; text-transform: uppercase; margin-bottom: 4px; transition: 0.2s; }
        .btn-map { background: var(--cyan); color: #000; }
        .btn-save { background: #28a745; color: #fff; }
        .btn-record { background: #dc3545; color: #fff; }
        .btn-warning { background: var(--warning); color: #000; }
        input, select { width: 100%; padding: 7px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; font-size: 11px; }
        label { font-size: 9px; color: #aaa; display: block; margin: 5px 0 2px; text-transform: uppercase; }
        .team-marker { position: absolute; transform: translate(-50%, -50%); border-radius: 50%; border: 3px solid; background-color: #FFF; background-size: 85%; background-repeat: no-repeat; background-position: center; }
        .warning-marker { position: absolute; transform: translate(-50%, -50%); width: 25px; height: 25px; background: var(--warning); border-radius: 50%; color: #000; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 20; pointer-events: auto; }
        .warning-popup { position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 10px; border-radius: 8px; width: 180px; display: none; flex-direction: column; z-index: 100; font-size: 12px; }
        .warning-marker:hover .warning-popup { display: flex; }
        .timeline-box { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(10, 10, 20, 0.95); padding: 12px 20px; border-radius: 40px; border: 1px solid var(--cyan); z-index: 100; display: flex; align-items: center; gap: 15px; }
        #timeline { flex: 1; accent-color: var(--cyan); }
    </style>
</head>
<body>

<div class="main-container">
    <div class="sidebar">
        <button class="btn-map" onclick="document.getElementById('map-up').click()">üñºÔ∏è CARREGAR MAPA</button>
        <input type="file" id="map-up" style="display:none" onchange="loadMap(this)">
        
        <div class="control-box">
            <label>üíæ ARQUIVOS DE AN√ÅLISE</label>
            <button class="btn-save" onclick="exportData()">BAIXAR DADOS (.JSON)</button>
            <button class="btn-map" onclick="document.getElementById('import-up').click()">IMPORTAR DADOS</button>
            <input type="file" id="import-up" style="display:none" onchange="importData(this)">
            <button class="btn-record" id="rec-btn" onclick="toggleRecording()">üé• GRAVAR REPLAY (MP4)</button>
        </div>

        <div class="control-box">
            <label>üî• HEATMAP E NEON</label>
            <input type="range" id="heat-int" min="10" max="150" value="80" oninput="forceUpdate()">
            <input type="range" id="neon-power" min="0" max="150" value="100" oninput="forceUpdate()">
            <label>TAMANHO LOGO / ESCURID√ÉO</label>
            <input type="range" id="logo-size" min="20" max="80" value="45" oninput="forceUpdate()">
            <input type="range" id="map-dark" min="0" max="100" value="85" oninput="updateDarkness(this.value)">
        </div>

        <div class="control-box">
            <label>‚ö†Ô∏è AVISO M√çDIA</label>
            <input type="text" id="warn-text" placeholder="Texto...">
            <input type="file" id="warn-file" accept="image/*,video/*">
            <button class="btn-warning" onclick="currentMode='warning'">üìç MARCAR AVISO</button>
        </div>
    </div>

    <div class="map-wrapper" id="capture-area">
        <div id="map-area" onclick="handleMapClick(event)">
            <div id="map-darkener"></div>
            <canvas id="c-heat"></canvas>
            <canvas id="c-lines"></canvas>
            <div id="p-layer"></div>
        </div>
        <div class="timeline-box">
            <span id="timer-txt" style="font-family: monospace; color: var(--cyan);">00:00</span>
            <input type="range" id="timeline" min="0" max="1200" value="0" oninput="manualSeek(this.value)">
            <button id="play-btn" style="background:var(--neon); color:#000; width:80px;" onclick="togglePlay()">‚ñ∂ PLAY</button>
        </div>
    </div>

    <div class="sidebar">
        <label>TEMPO (S) / TIME</label>
        <input type="number" id="m-time" value="0">
        <select id="team-select"></select>
        <label>NOMES DOS TIMES</label>
        <input type="text" id="teams-input" value="LOUD, PAIN, FLUXO" onchange="updateTeams()">
        <div id="v-list" style="flex:1; overflow-y:auto; margin-top:10px;"></div>
    </div>
</div>

<script>
    let teamData = {}, teamLogos = {}, warnings = [], playing = false, currentTime = 0, lastTimestamp = 0, currentMode = 'route';
    let mediaRecorder, recordedChunks = [];
    const neonColors = ['#00ffff','#ff00ff','#39ff14','#ffff00','#ff3131','#ff8c00','#00ffcc','#bc13fe','#8eff00','#0070ff','#ff007f','#ffffff'];
    const cH = document.getElementById('c-heat'), cL = document.getElementById('c-lines'), mapArea = document.getElementById('map-area');
    const ctxH = cH.getContext('2d'), ctxL = cL.getContext('2d');

    window.onload = () => { updateTeams(); resize(); updateDarkness(85); };
    function resize() { const r = mapArea.getBoundingClientRect(); cH.width = cL.width = r.width; cH.height = cL.height = r.height; forceUpdate(); }
    function updateDarkness(v) { document.getElementById('map-darkener').style.background = `rgba(0,0,0,${v/100})`; }

    function updateTeams() {
        const names = document.getElementById('teams-input').value.split(',').map(t => t.trim());
        const tSel = document.getElementById('team-select'), vList = document.getElementById('v-list');
        tSel.innerHTML = ''; vList.innerHTML = '';
        names.forEach((t, i) => {
            const col = neonColors[i % neonColors.length];
            tSel.innerHTML += `<option value="${t}">${t}</option>`;
            vList.innerHTML += `<div class="team-item" style="border-color:${col}"><strong>${t}</strong><br><button class="btn-map" style="font-size:8px" onclick="document.getElementById('file-${t}').click()">LOGO</button><input type="file" id="file-${t}" style="display:none" onchange="importLogo(this, '${t}')"></div>`;
            if(!teamData[t]) teamData[t] = [];
        });
    }

    function importLogo(input, t) { if (input.files[0]) { const r = new FileReader(); r.onload = e => { teamLogos[t] = e.target.result; forceUpdate(); }; r.readAsDataURL(input.files[0]); } }

    function handleMapClick(e) {
        const r = mapArea.getBoundingClientRect();
        const x = ((e.clientX - r.left) / r.width) * 100, y = ((e.clientY - r.top) / r.height) * 100;
        if (currentMode === 'warning') {
            const text = document.getElementById('warn-text').value;
            const file = document.getElementById('warn-file').files[0];
            const warnObj = { x, y, text, type: 'none', src: '' };
            if(file) {
                warnObj.type = file.type.startsWith('video') ? 'video' : 'image';
                const reader = new FileReader();
                reader.onload = ev => { warnObj.src = ev.target.result; warnings.push(warnObj); forceUpdate(); };
                reader.readAsDataURL(file);
            } else { warnings.push(warnObj); forceUpdate(); }
            currentMode = 'route';
        } else {
            const team = document.getElementById('team-select').value;
            const t = parseFloat(document.getElementById('m-time').value);
            teamData[team].push({x, y, time: t});
            teamData[team].sort((a,b) => a.time - b.time);
            document.getElementById('m-time').value = t + 10;
            currentTime = t;
        }
        forceUpdate();
    }

    function forceUpdate() {
        ctxL.clearRect(0,0,cL.width, cL.height); ctxH.clearRect(0,0,cH.width, cH.height);
        const neon = document.getElementById('neon-power').value;
        const hInt = document.getElementById('heat-int').value / 100;
        Object.keys(teamData).forEach((t, i) => {
            if(teamData[t].length < 1) return;
            const col = neonColors[i % neonColors.length];
            ctxL.shadowBlur = neon; ctxL.shadowColor = col; ctxL.strokeStyle = col; ctxL.lineWidth = 4;
            ctxL.beginPath();
            teamData[t].forEach((p, idx) => {
                const px = (p.x/100)*cL.width, py = (p.y/100)*cL.height;
                idx === 0 ? ctxL.moveTo(px, py) : ctxL.lineTo(px, py);
                let grad = ctxH.createRadialGradient(px, py, 0, px, py, 40);
                grad.addColorStop(0, `rgba(255, 60, 0, ${hInt})`); grad.addColorStop(1, 'rgba(0,0,0,0)');
                ctxH.fillStyle = grad; ctxH.fillRect(px-40, py-40, 80, 80);
            });
            ctxL.stroke();
        });
        renderElements();
    }

    function renderElements() {
        const layer = document.getElementById('p-layer'), lSize = document.getElementById('logo-size').value;
        layer.innerHTML = '';
        Object.keys(teamData).forEach((t, i) => {
            if(!teamData[t].length) return;
            const pos = interpolate(teamData[t], currentTime), col = neonColors[i % neonColors.length];
            const div = document.createElement('div');
            div.className = 'team-marker'; div.style = `left:${pos.x}%; top:${pos.y}%; width:${lSize}px; height:${lSize}px; border-color:${col}; box-shadow: 0 0 ${lSize/2}px ${col};`;
            if(teamLogos[t]) div.style.backgroundImage = `url('${teamLogos[t]}')`;
            layer.appendChild(div);
        });
        warnings.forEach(w => {
            const d = document.createElement('div'); d.className = 'warning-marker'; d.style = `left:${w.x}%; top:${w.y}%;`;
            d.innerHTML = `!<div class="warning-popup"><strong>AVISO:</strong> ${w.text}${w.type==='image'?'<img src="'+w.src+'" style="width:100%">':''}</div>`;
            layer.appendChild(d);
        });
        updateTimelineUI();
    }

    function interpolate(pts, t) {
        if(t <= pts[0].time) return pts[0]; if(t >= pts[pts.length-1].time) return pts[pts.length-1];
        for(let i=0; i<pts.length-1; i++){
            if(t >= pts[i].time && t <= pts[i+1].time){
                const pct = (t - pts[i].time) / (pts[i+1].time - pts[i].time);
                return { x: pts[i].x + (pts[i+1].x - pts[i].x)*pct, y: pts[i].y + (pts[i+1].y - pts[i].y)*pct };
            }
        }
        return pts[pts.length-1];
    }

    function togglePlay() { playing = !playing; document.getElementById('play-btn').innerText = playing ? "‚è∏ PAUSE" : "‚ñ∂ PLAY"; if(playing) { lastTimestamp = performance.now(); gameLoop(); } }
    function gameLoop() { if(!playing) return; const now = performance.now(); currentTime += (now - lastTimestamp) / 1000; lastTimestamp = now; forceUpdate(); requestAnimationFrame(gameLoop); }
    function manualSeek(v) { currentTime = parseFloat(v); forceUpdate(); }
    function updateTimelineUI() { document.getElementById('timeline').value = currentTime; const m = Math.floor(currentTime/60).toString().padStart(2,'0'), s = Math.floor(currentTime%60).toString().padStart(2,'0'); document.getElementById('timer-txt').innerText = `${m}:${s}`; }
    function loadMap(i){ if(i.files[0]){ const r=new FileReader(); r.onload=e=>{mapArea.style.backgroundImage=`url('${e.target.result}')`;setTimeout(resize, 100);}; r.readAsDataURL(i.files[0]);}}

    // FUN√á√ïES DE EXPORTA√á√ÉO
    function exportData() {
        const data = JSON.stringify({ teamData, teamLogos, warnings });
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'analise_votation.json'; a.click();
    }

    function importData(input) {
        if (input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                const d = JSON.parse(e.target.result);
                teamData = d.teamData; teamLogos = d.teamLogos; warnings = d.warnings;
                forceUpdate();
            };
            r.readAsText(input.files[0]);
        }
    }

    async function toggleRecording() {
        if (!mediaRecorder || mediaRecorder.state === "inactive") {
            const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'replay_analise.mp4'; a.click();
                recordedChunks = [];
            };
            mediaRecorder.start();
            document.getElementById('rec-btn').innerText = "üõë PARAR GRAVA√á√ÉO";
        } else {
            mediaRecorder.stop();
            document.getElementById('rec-btn').innerText = "üé• GRAVAR REPLAY (MP4)";
        }
    }
</script>
</body>
</html>
