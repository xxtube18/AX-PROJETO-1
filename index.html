<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COACH LIPEE - V43 ULTRA HEAT</title>
    <style>
        :root { --neon: #00FF00; --bg: #0a0a0b; --card: #151517; --border: #2a2a2e; }
        body { background: var(--bg); margin: 0; font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; height: 100vh; }
        #main-app { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
        #sidebar { background: var(--card); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .tool-card { background: #1c1c1f; border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
        .tool-card h4 { margin: 0 0 8px 0; font-size: 11px; color: var(--neon); text-transform: uppercase; }
        .btn { background: #252529; border: none; color: #a0a0a5; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: 600; width: 100%; margin-bottom: 4px; }
        .btn.active { background: var(--neon) !important; color: #000 !important; }
        
        #viewport { position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #map-container { position: relative; line-height: 0; }
        #game-map { max-width: 92vw; max-height: 82vh; display: block; }
        
        .night-vision #game-map { filter: brightness(0.4) contrast(1.2) sepia(1) hue-rotate(80deg) saturate(2.5) !important; }
        
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; pointer-events: all; cursor: crosshair; }
        
        /* Ajuste de opacidade para o Heatmap aparecer mais */
        #heatmap-layer { z-index: 5; opacity: 0.9; mix-blend-mode: screen; }
        #vector-layer { z-index: 10; }
        
        #timeline-bar { position: absolute; bottom: 20px; width: 80%; background: rgba(0,0,0,0.95); padding: 15px; border-radius: 10px; border: 1px solid var(--neon); display: none; z-index: 150; text-align: center; }
        .input-dark { background: #0a0a0b; border: 1px solid var(--border); color: white; padding: 6px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 12px; margin-bottom: 5px; }
        label { font-size: 9px; color: var(--neon); font-weight: bold; display: block; margin: 4px 0; }
    </style>
</head>
<body>

<div id="main-app">
    <div id="sidebar">
        <h2 style="color:var(--neon); text-align:center; margin:0; font-size: 18px;">COACH LIPEE</h2>
        
        <div class="tool-card">
            <h4>üó∫Ô∏è MAPA & VIS√ÉO</h4>
            <input type="file" id="up-map" accept="image/*" class="input-dark">
            <button class="btn" id="toggle-night">üåô VIS√ÉO NO ESCURO: OFF</button>
        </div>

        <div class="tool-card">
            <h4>üõ°Ô∏è MODOS</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                <button class="btn btn-mode active" id="mode-route">ROTA</button>
                <button class="btn btn-mode" id="mode-safe">SAFE</button>
                <button class="btn btn-mode" id="mode-gas">G√ÅS V45</button>
                <button class="btn" onclick="undo()" style="background:#c0392b; color:white;">VOLTAR</button>
            </div>
            <label>TEMPO DE A√á√ÉO (MM:SS)</label>
            <input type="text" id="manual-time" value="00:00" class="input-dark">
        </div>

        <div class="tool-card">
            <h4>üî• HEATMAP (CALOR ALTO)</h4>
            <label>INTENSIDADE/RAIO</label>
            <input type="range" id="heat-radius" min="10" max="100" value="45" style="width:100%">
            <button class="btn" onclick="clearHeat()">LIMPAR CALOR</button>
        </div>

        <div class="tool-card">
            <h4>üéÆ TIME & LOGO</h4>
            <select id="team-slot" class="input-dark"></select>
            <input type="text" id="team-tag" placeholder="TAG" class="input-dark">
            <input type="file" id="up-logo" accept="image/*" class="input-dark">
            <label>TAMANHO DA LOGO</label>
            <input type="range" id="logo-size" min="15" max="60" value="34" style="width:100%">
        </div>

        <div class="tool-card">
            <h4>‚è© REPLAY</h4>
            <select id="replay-speed" class="input-dark">
                <option value="1">1x</option>
                <option value="2">2x</option>
                <option value="4">4x</option>
            </select>
            <button class="btn" id="start-replay" style="background:var(--neon); color:black; font-weight:bold;">‚ñ∂Ô∏è INICIAR AN√ÅLISE</button>
        </div>
    </div>

    <div id="viewport">
        <div id="map-container">
            <img id="game-map" src="">
            <canvas id="heatmap-layer" class="layer"></canvas>
            <canvas id="vector-layer" class="layer"></canvas>
            <div id="interaction-layer"></div>
        </div>
        <div id="timeline-bar">
            <div id="time-viewer" style="color:var(--neon); font-weight:bold; font-size: 20px;">00:00</div>
            <input type="range" id="timeline-slider" min="0" max="0" step="0.1" value="0" style="width:90%">
        </div>
    </div>
</div>

<script>
const state = {
    mapLoaded: false, mode: 'route', activeSlot: 1, animating: false, nightMode: false,
    teams: {}, history: {}, safeHistory: [], gasHistory: [], 
    maxSeconds: 0, animId: null, startTime: 0
};

const vCanvas = document.getElementById('vector-layer');
const hCanvas = document.getElementById('heatmap-layer');
const vCtx = vCanvas.getContext('2d');
const hCtx = hCanvas.getContext('2d');
const teamColors = ['#FF0000','#00FF00','#0080FF','#FFFF00','#FF00FF','#00FFFF','#FFA500','#CC00FF','#00FF7F','#FFD700','#FF69B4','#40E0D0'];

for(let i=1; i<=12; i++) {
    state.teams[i] = { tag: `TIME ${i}`, color: teamColors[i-1], logo: null };
    state.history[i] = [];
    document.getElementById('team-slot').add(new Option(`Time ${i}`, i));
}

function timeToSec(str) {
    const p = str.split(':');
    return (parseInt(p[0]) * 60) + (parseInt(p[1] || 0));
}

function secToTime(sec) {
    const m = Math.floor(sec / 60).toString().padStart(2, '0');
    const s = Math.floor(sec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}

// HEATMAP COM CORES FORTES E VIVAS
function drawHeatmap() {
    hCtx.clearRect(0, 0, hCanvas.width, hCanvas.height);
    const radius = parseInt(document.getElementById('heat-radius').value);
    
    Object.keys(state.history).forEach(id => {
        state.history[id].forEach(p => {
            const x = p.x * hCanvas.width;
            const y = p.y * hCanvas.height;
            const grad = hCtx.createRadialGradient(x, y, 0, x, y, radius);
            
            // Cores mais densas para parecer "quente"
            grad.addColorStop(0, 'rgba(255, 0, 0, 0.8)');    // Vermelho Intenso
            grad.addColorStop(0.3, 'rgba(255, 120, 0, 0.5)'); // Laranja
            grad.addColorStop(0.6, 'rgba(255, 255, 0, 0.3)'); // Amarelo
            grad.addColorStop(1, 'rgba(0, 255, 0, 0)');       // Verde sumindo
            
            hCtx.fillStyle = grad;
            hCtx.beginPath();
            hCtx.arc(x, y, radius, 0, Math.PI * 2);
            hCtx.fill();
        });
    });
}

function getPosAtTime(history, currentSec) {
    if (history.length === 0) return null;
    if (currentSec <= history[0].time) return history[0];
    if (currentSec >= history[history.length - 1].time) return history[history.length - 1];
    for (let i = 0; i < history.length - 1; i++) {
        const p1 = history[i], p2 = history[i + 1];
        if (currentSec >= p1.time && currentSec <= p2.time) {
            const ratio = (currentSec - p1.time) / (p2.time - p1.time || 1);
            return { x: p1.x + (p2.x - p1.x) * ratio, y: p1.y + (p2.y - p1.y) * ratio, time: currentSec };
        }
    }
}

function render(currentSec = null) {
    if(!state.mapLoaded) return;
    vCtx.clearRect(0, 0, vCanvas.width, vCanvas.height);
    drawHeatmap();
    
    const w = vCanvas.width, h = vCanvas.height;
    const logoS = parseInt(document.getElementById('logo-size').value);

    // Safes
    state.safeHistory.forEach(s => {
        vCtx.beginPath(); vCtx.arc(s.x*w, s.y*h, s.r*w, 0, Math.PI*2);
        vCtx.strokeStyle = "#f1c40f"; vCtx.setLineDash([5,5]); vCtx.lineWidth = 2; vCtx.stroke(); vCtx.setLineDash([]);
    });

    // Times
    Object.keys(state.history).forEach(id => {
        const hist = state.history[id];
        if (hist.length === 0) return;
        const team = state.teams[id];
        
        vCtx.beginPath(); vCtx.strokeStyle = team.color; vCtx.lineWidth = 2;
        hist.forEach((p, i) => i === 0 ? vCtx.moveTo(p.x*w, p.y*h) : vCtx.lineTo(p.x*w, p.y*h));
        vCtx.stroke();

        const p = currentSec !== null ? getPosAtTime(hist, currentSec) : hist[hist.length-1];
        if(!p) return;

        vCtx.fillStyle = "white"; vCtx.beginPath(); vCtx.arc(p.x*w, p.y*h, logoS/2 + 2, 0, Math.PI*2); vCtx.fill();
        if(team.logo) {
            vCtx.save(); vCtx.beginPath(); vCtx.arc(p.x*w, p.y*h, logoS/2, 0, Math.PI*2); vCtx.clip();
            vCtx.drawImage(team.logo, p.x*w - logoS/2, p.y*h - logoS/2, logoS, logoS); vCtx.restore();
        } else {
            vCtx.fillStyle = team.color; vCtx.beginPath(); vCtx.arc(p.x*w, p.y*h, logoS/2, 0, Math.PI*2); vCtx.fill();
        }

        vCtx.textAlign = "center";
        vCtx.fillStyle = "white"; vCtx.font = "bold 12px Arial";
        vCtx.fillText(team.tag, p.x*w, p.y*h - (logoS/2 + 8));
        vCtx.fillStyle = team.color;
        vCtx.fillText(secToTime(currentSec || p.time), p.x*w, p.y*h - (logoS/2 + 22));
    });
}

function animate(timestamp) {
    if (!state.animating) return;
    if (!state.startTime) state.startTime = timestamp;
    
    const slider = document.getElementById('timeline-slider');
    const speed = parseFloat(document.getElementById('replay-speed').value);
    let elapsed = (timestamp - state.startTime) / 1000 * speed;
    
    if (elapsed > state.maxSeconds) {
        state.startTime = timestamp;
        elapsed = 0;
    }
    
    slider.value = elapsed;
    document.getElementById('time-viewer').innerText = secToTime(elapsed);
    render(elapsed);
    state.animId = requestAnimationFrame(animate);
}

document.getElementById('start-replay').onclick = function() {
    state.animating = !state.animating;
    this.innerText = state.animating ? "‚èπÔ∏è PARAR REPLAY" : "‚ñ∂Ô∏è INICIAR AN√ÅLISE";
    document.getElementById('timeline-bar').style.display = state.animating ? "block" : "none";
    if (state.animating) {
        state.startTime = 0;
        document.getElementById('timeline-slider').max = state.maxSeconds;
        state.animId = requestAnimationFrame(animate);
    } else {
        cancelAnimationFrame(state.animId);
        render();
    }
};

const inter = document.getElementById('interaction-layer');
inter.onmousedown = e => {
    if(!state.mapLoaded) return;
    const rect = inter.getBoundingClientRect();
    const x = (e.clientX - rect.left) / rect.width, y = (e.clientY - rect.top) / rect.height;
    const sec = timeToSec(document.getElementById('manual-time').value);

    if(state.mode === 'route') {
        state.history[state.activeSlot].push({x, y, time: sec});
        if(sec > state.maxSeconds) state.maxSeconds = sec;
    } else if(state.mode === 'safe') {
        state.safeHistory.push({x, y, r: 0.1, time: sec});
    }
    render();
};

document.getElementById('toggle-night').onclick = function() {
    state.nightMode = !state.nightMode;
    document.getElementById('map-container').classList.toggle('night-vision', state.nightMode);
    this.innerText = state.nightMode ? "üåô VIS√ÉO NO ESCURO: ON" : "üåô VIS√ÉO NO ESCURO: OFF";
    this.style.background = state.nightMode ? "var(--neon)" : "#252529";
    this.style.color = state.nightMode ? "#000" : "#a0a0a5";
};

document.getElementById('up-map').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        document.getElementById('game-map').src = ev.target.result;
        document.getElementById('game-map').onload = () => {
            state.mapLoaded = true;
            hCanvas.width = vCanvas.width = document.getElementById('game-map').clientWidth;
            hCanvas.height = vCanvas.height = document.getElementById('game-map').clientHeight;
            render();
        };
    };
    reader.readAsDataURL(e.target.files[0]);
};

document.getElementById('up-logo').onchange = e => {
    const reader = new FileReader();
    reader.onload = ev => {
        const img = new Image(); img.src = ev.target.result;
        img.onload = () => { state.teams[state.activeSlot].logo = img; render(); };
    };
    reader.readAsDataURL(e.target.files[0]);
};

document.querySelectorAll('.btn-mode').forEach(btn => {
    btn.onclick = function() {
        document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
        this.classList.add('active'); state.mode = this.id.replace('mode-', '');
    };
});

document.getElementById('team-slot').onchange = e => {
    state.activeSlot = e.target.value;
    document.getElementById('team-tag').value = state.teams[state.activeSlot].tag;
};
document.getElementById('team-tag').oninput = e => { state.teams[state.activeSlot].tag = e.target.value; render(); };
function undo() { state.history[state.activeSlot].pop(); render(); }
function clearHeat() { Object.keys(state.history).forEach(i => state.history[i] = []); render(); }
document.getElementById('logo-size').oninput = render;
document.getElementById('heat-radius').oninput = render;
</script>
</body>
</html>
