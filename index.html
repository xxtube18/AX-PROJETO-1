<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COACH LIPEE - MANUAL TIME V36</title>
    <style>
        :root { --neon-green: #00FF00; --dark-bg: #050505; --panel-bg: rgba(15, 15, 15, 0.98); }
        body { background: var(--dark-bg); margin: 0; font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; }
        
        #controls-panel {
            background: var(--panel-bg); padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; 
            justify-content: center; align-items: center; border-bottom: 2px solid #333; z-index: 100;
        }

        .control-group { background: #1a1a1a; padding: 6px 12px; border-radius: 6px; border: 1px solid #333; display: flex; align-items: center; gap: 8px; }
        label { font-weight: bold; color: var(--neon-green); font-size: 10px; text-transform: uppercase; }
        input[type=range] { accent-color: var(--neon-green); width: 70px; }
        
        .action-btn { padding: 8px 15px; border-radius: 4px; border: none; font-weight: 900; cursor: pointer; font-size: 10px; text-transform: uppercase; transition: 0.2s; }
        .btn-safe { background: #f1c40f; color: #000; }
        .btn-marker { background: var(--neon-green); color: #000; }
        .btn-view { background: #3498db; color: #fff; }
        .btn-time { background: #e74c3c; color: #fff; }
        .btn-anim { background: #9b59b6; color: #fff; box-shadow: 0 0 10px #9b59b6; }
        .btn-save { background: #2ecc71; color: #000; }

        #viewport { position: relative; width: 100vw; height: calc(100vh - 80px); display: flex; justify-content: center; align-items: center; background: #000; }
        #map-container { position: relative; display: inline-block; }
        #game-map { max-width: 98vw; max-height: 80vh; display: block; filter: brightness(60%) contrast(1.1); }
        
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #heatmap-layer { z-index: 5; mix-blend-mode: screen; }
        #vector-layer { z-index: 10; }
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 50; pointer-events: all; }

        .map-marker { 
            position: absolute; width: 20px; height: 20px; background: var(--neon-green); 
            border-radius: 50%; border: 2px solid white; cursor: pointer; z-index: 100;
            display: flex; align-items: center; justify-content: center; font-weight: bold; color: black; font-size: 14px;
            pointer-events: auto;
        }

        /* Modal de Aviso */
        #modal-aviso {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #111; border: 2px solid var(--neon-green); padding: 20px; z-index: 1000; border-radius: 8px; width: 300px;
        }
        #modal-aviso input, #modal-aviso textarea { width: 100%; background: #222; color: white; border: 1px solid #444; margin-bottom: 10px; }

        #hud { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 4px; border-left: 4px solid var(--neon-green); font-size: 11px; z-index: 60; pointer-events: none; }
        .input-dark { background:#222; color:#fff; border:1px solid #444; padding: 2px; }
    </style>
</head>
<body>

    <div id="controls-panel">
        <div class="control-group"><label>üìÇ MAPA</label><input type="file" id="up-map" accept="image/*"></div>
        <div class="control-group"><label>üåë BRILHO</label><input type="range" id="map-bright" min="10" max="100" value="60"></div>
        
        <div class="control-group">
            <label>üî• RAIO</label><input type="range" id="heat-radius" min="10" max="150" value="40">
            <label>üîÜ DENS</label><input type="range" id="heat-opacity" min="0.1" max="1.0" step="0.1" value="0.5">
        </div>

        <div class="control-group">
            <label>SLOT</label><select id="team-slot" class="input-dark"></select>
            <input type="text" id="team-tag" placeholder="TAG" style="width:40px;" class="input-dark">
        </div>

        <div class="control-group">
            <button class="action-btn btn-safe" id="mode-safe">SAFE: OFF</button>
            <button class="action-btn btn-marker" id="mode-marker">‚ö†Ô∏è ADD AVISO</button>
            <button class="action-btn btn-view" id="toggle-vectors">üëÅÔ∏è VER</button>
        </div>

        <div style="display: flex; gap: 6px;">
            <button class="action-btn btn-anim" id="start-replay">‚ñ∂Ô∏è REPLAY</button>
            <button class="action-btn btn-save" id="export-btn">üíæ SALVAR</button>
            <button class="action-btn" style="background:#444; color:#fff" onclick="location.reload()">üóëÔ∏è RESET</button>
        </div>
    </div>

    <div id="viewport">
        <div id="map-container">
            <img id="game-map" src="">
            <canvas id="heatmap-layer" class="layer"></canvas>
            <canvas id="vector-layer" class="layer"></canvas>
            <div id="interaction-layer"></div>
            <div id="markers-container" class="layer"></div>
        </div>
        <div id="hud">STATUS: <span id="hud-mode" style="color:var(--neon-green)">NORMAL</span></div>
    </div>

    <div id="modal-aviso">
        <h3>ADICIONAR AVISO</h3>
        <textarea id="aviso-texto" placeholder="Descreva o aviso..."></textarea>
        <label>Foto/V√≠deo:</label>
        <input type="file" id="aviso-file" accept="image/*,video/*">
        <button class="action-btn btn-save" onclick="salvarMarcador()">SALVAR</button>
        <button class="action-btn" onclick="fecharModal()" style="background:#e74c3c">CANCELAR</button>
    </div>

    <script>
        const state = { 
            mapLoaded: false, safeMode: false, markerMode: false, showVectors: true, activeSlot: 1,
            teams: {}, history: {}, safeHistory: [], markers: [], 
            tempPos: null 
        };
        
        const PALETTE = [[0,0,255], [0,104,55], [26,152,80], [166,217,106], [217,239,139], [254,224,139], [253,174,97], [244,109,67], [215,48,39], [165,0,38]];
        const canvases = { heat: document.getElementById('heatmap-layer'), vector: document.getElementById('vector-layer') };
        const ctxs = { heat: canvases.heat.getContext('2d'), vector: canvases.vector.getContext('2d') };

        for(let i=1; i<=12; i++) {
            state.teams[i] = { tag: `T${i}`, color: getTeamColor(i) };
            state.history[i] = [];
            document.getElementById('team-slot').add(new Option(`Slot ${i}`, i));
        }

        function getTeamColor(i) {
            return ['#FF0000', '#00FF00', '#0080FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#CC00FF', '#00FF7F', '#FFD700', '#FF69B4', '#40E0D0'][i-1];
        }

        document.getElementById('up-map').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => { 
                document.getElementById('game-map').src = ev.target.result; 
                document.getElementById('game-map').onload = () => { state.mapLoaded = true; resize(); }; 
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function resize() {
            const rect = document.getElementById('game-map').getBoundingClientRect();
            canvases.heat.width = canvases.vector.width = rect.width;
            canvases.heat.height = canvases.vector.height = rect.height;
            render();
        }

        document.getElementById('interaction-layer').onmousedown = (e) => {
            if(!state.mapLoaded) return;
            const rect = e.target.getBoundingClientRect();
            const nx = (e.clientX - rect.left) / rect.width;
            const ny = (e.clientY - rect.top) / rect.height;

            if(state.markerMode) {
                state.tempPos = { x: nx, y: ny };
                document.getElementById('modal-aviso').style.display = 'block';
                return;
            }
            if(state.safeMode) {
                state.safeHistory.push({ x: nx, y: ny, r: 0.15 });
            } else {
                state.history[state.activeSlot].push({ x: nx, y: ny, time: "0" });
            }
            render();
        };

        function salvarMarcador() {
            const texto = document.getElementById('aviso-texto').value;
            const fileInput = document.getElementById('aviso-file');
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.markers.push({ ...state.tempPos, texto, midia: e.target.result, tipo: file.type });
                    fecharModal();
                    renderMarkers();
                };
                reader.readAsDataURL(file);
            } else {
                state.markers.push({ ...state.tempPos, texto, midia: null });
                fecharModal();
                renderMarkers();
            }
        }

        function fecharModal() {
            document.getElementById('modal-aviso').style.display = 'none';
            document.getElementById('aviso-texto').value = '';
            document.getElementById('aviso-file').value = '';
            state.markerMode = false;
            document.getElementById('mode-marker').style.background = 'var(--neon-green)';
        }

        function renderMarkers() {
            const container = document.getElementById('markers-container');
            container.innerHTML = '';
            const rect = document.getElementById('game-map').getBoundingClientRect();

            state.markers.forEach((m, i) => {
                const div = document.createElement('div');
                div.className = 'map-marker';
                div.style.left = (m.x * 100) + '%';
                div.style.top = (m.y * 100) + '%';
                div.innerHTML = '!';
                div.onclick = () => {
                    const win = window.open("", "_blank", "width=400,height=400");
                    win.document.write(`<body style="background:#000;color:#fff;font-family:sans-serif;text-align:center">
                        <p>${m.texto}</p>
                        ${m.midia ? (m.tipo.includes('video') ? `<video src="${m.midia}" controls width="350">` : `<img src="${m.midia}" width="350">`) : ''}
                    </body>`);
                };
                container.appendChild(div);
            });
        }

        function drawHeat() {
            const w = canvases.heat.width, h = canvases.heat.height;
            if(w === 0 || !state.mapLoaded) return;
            const radius = parseInt(document.getElementById('heat-radius').value);
            const opacity = parseFloat(document.getElementById('heat-opacity').value);
            const temp = document.createElement('canvas'); 
            temp.width = w * 0.5; temp.height = h * 0.5;
            const tctx = temp.getContext('2d'); 
            tctx.fillStyle = "rgb(0,0,255)"; tctx.fillRect(0,0,temp.width,temp.height);
            tctx.globalCompositeOperation = "lighter";
            Object.values(state.history).forEach(hist => hist.forEach(p => {
                let g = tctx.createRadialGradient(p.x*temp.width, p.y*temp.height, 0, p.x*temp.width, p.y*temp.height, radius/2);
                g.addColorStop(0, "rgba(255,255,255,0.5)"); g.addColorStop(1, "rgba(255,255,255,0)");
                tctx.fillStyle = g; tctx.beginPath(); tctx.arc(p.x*temp.width, p.y*temp.height, radius/2, 0, Math.PI*2); tctx.fill();
            }));
            const data = tctx.getImageData(0,0,temp.width,temp.height);
            for(let i=0; i<data.data.length; i+=4) { 
                const b = data.data[i]; const c = PALETTE[Math.min(9, Math.floor((b/255)*12))] || PALETTE[0]; 
                data.data[i] = c[0]; data.data[i+1] = c[1]; data.data[i+2] = c[2]; 
            }
            tctx.putImageData(data,0,0); ctxs.heat.clearRect(0,0,w,h); ctxs.heat.globalAlpha = opacity; ctxs.heat.drawImage(temp, 0, 0, w, h);
        }

        function drawVectors() {
            const w = canvases.vector.width, h = canvases.vector.height;
            ctxs.vector.clearRect(0,0,w,h);
            if(!state.showVectors) return;
            Object.keys(state.history).forEach(id => {
                const hist = state.history[id], team = state.teams[id];
                if(hist.length === 0) return;
                ctxs.vector.beginPath(); ctxs.vector.strokeStyle = team.color; ctxs.vector.lineWidth = 2;
                hist.forEach((p, i) => i===0 ? ctxs.vector.moveTo(p.x*w,p.y*h) : ctxs.vector.lineTo(p.x*w,p.y*h));
                ctxs.vector.stroke();
            });
        }

        function render() { drawHeat(); drawVectors(); renderMarkers(); }

        document.getElementById('mode-marker').onclick = () => {
            state.markerMode = !state.markerMode;
            state.safeMode = false;
            document.getElementById('mode-marker').style.background = state.markerMode ? '#fff' : 'var(--neon-green)';
            document.getElementById('hud-mode').innerText = state.markerMode ? "ADD AVISO" : "NORMAL";
        };

        document.getElementById('mode-safe').onclick = () => {
            state.safeMode = !state.safeMode;
            state.markerMode = false;
            document.getElementById('mode-safe').innerText = state.safeMode ? "SAFE: ON" : "SAFE: OFF";
        };

        document.getElementById('heat-radius').oninput = render;
        document.getElementById('heat-opacity').oninput = render;
        window.onresize = resize;
    </script>
</body>
</html>
