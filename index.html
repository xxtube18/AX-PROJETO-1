<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>COACH LIPEE - TACTICAL V46 PRO</title>
    <style>
        :root { --neon: #00FF00; --bg: #0a0a0b; --card: #151517; --border: #2a2a2e; }
        body { background: var(--bg); margin: 0; font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; }
        #main-app { display: grid; grid-template-columns: 320px 1fr; height: 100vh; }
        #sidebar { background: var(--card); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; }
        .tool-card { background: #1c1c1f; border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
        .tool-card h4 { margin: 0 0 8px 0; font-size: 10px; color: var(--neon); text-transform: uppercase; letter-spacing: 1px; }
        .btn { background: #252529; border: none; color: #a0a0a5; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 600; transition: 0.2s; text-align: center; }
        .btn:hover { background: #303035; color: #fff; }
        .btn.active { background: var(--neon) !important; color: #000 !important; }
        #viewport { position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #map-container { position: relative; cursor: crosshair; }
        #game-map { max-width: 90vw; max-height: 85vh; display: block; filter: brightness(0.7); border-radius: 4px; }
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: all; }
        input[type=range] { width: 100%; accent-color: var(--neon); margin: 5px 0; cursor: pointer; }
        select, input[type=text] { width: 100%; background: #0a0a0b; border: 1px solid var(--border); color: #fff; padding: 6px; border-radius: 4px; font-size: 11px; margin-bottom: 5px; }
        
        /* Modal de Aviso */
        #call-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); border: 2px solid var(--neon); padding: 20px; z-index: 1000; display: none; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 0 30px rgba(0,255,0,0.2); }
        #call-modal img { max-width: 100%; margin-top: 10px; border-radius: 4px; border: 1px solid #444; }
        #call-modal button { margin-top: 15px; width: 100%; padding: 8px; background: var(--neon); border: none; font-weight: bold; cursor: pointer; }
        
        .timeline-box { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 60%; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 40px; display: none; border: 1px solid var(--neon); z-index: 100; }
    </style>
</head>
<body>

<div id="main-app">
    <div id="sidebar">
        <h2 style="color:var(--neon); margin:0; text-align: center; font-weight: 900;">COACH LIPEE</h2>
        
        <div class="tool-card">
            <h4>üó∫Ô∏è MAPAS</h4>
            <select id="map-select">
                <option value="">-- Selecionar --</option>
                <option value="https://i.imgur.com/8QOInU9.jpeg">Bermuda</option>
                <option value="https://i.imgur.com/R3t6f4D.jpeg">Purgat√≥rio</option>
                <option value="https://i.imgur.com/vH9Z3tM.jpeg">Alpine</option>
                <option value="LINK">Nova Terra</option>
                <option value="LINK">Kalahari</option>
                <option value="LINK">Solara</option>
            </select>
        </div>

        <div class="tool-card">
            <h4>üõ†Ô∏è FERRAMENTAS</h4>
            <div class="grid-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                <button class="btn btn-mode active" id="mode-route">ROTA + TIME</button>
                <button class="btn btn-mode" id="mode-safe">SAFE</button>
                <button class="btn btn-mode" id="mode-call" style="color: #00FF00;">üü¢ PONTO AVISO</button>
                <button class="btn btn-mode" id="mode-text">üí¨ TEXTO CALL</button>
            </div>
            <label style="font-size:9px; margin-top:8px; display:block">TAMANHO DA SAFE / LOGO</label>
            <input type="range" id="global-size" min="5" max="50" value="20">
        </div>

        <div class="tool-card">
            <h4>üî• MAPA DE CALOR</h4>
            <input type="range" id="heat-opacity" min="0" max="10" value="0">
            <input type="range" id="heat-radius" min="10" max="100" value="40">
        </div>

        <div class="tool-card">
            <h4>üéÆ TIMES</h4>
            <select id="team-slot"></select>
            <input type="text" id="team-name" placeholder="Nome do Time">
            <button class="btn" style="width:100%; background:#34495e; color:white" onclick="document.getElementById('up-logo').click()">üñºÔ∏è SUBIR LOGO</button>
            <input type="file" id="up-logo" style="display:none" accept="image/*">
        </div>

        <div class="tool-card" style="margin-top: auto;">
            <button class="btn" id="start-replay" style="width:100%; background:var(--neon); color:#000; font-weight:800; margin-bottom:5px;">‚ñ∂Ô∏è PLAY T√ÅTICO</button>
            <button class="btn" id="undo-btn" style="width:100%; background:#e67e22; color:white">‚Ü©Ô∏è DESFAZER</button>
        </div>
    </div>

    <div id="viewport">
        <div id="map-container">
            <img id="game-map" src="">
            <canvas id="heat-layer" class="layer" style="mix-blend-mode: color-dodge;"></canvas>
            <canvas id="vector-layer" class="layer"></canvas>
            <div id="interaction-layer"></div>
        </div>
    </div>
</div>

<div id="call-modal">
    <h3 id="modal-title" style="margin:0; color:var(--neon); font-size:14px;">CALL DE ELITE</h3>
    <p id="modal-desc" style="font-size:12px; margin: 10px 0;"></p>
    <div id="modal-img-container"></div>
    <button onclick="document.getElementById('call-modal').style.display='none'">FECHAR</button>
</div>

<script>
    const state = { mode: 'route', history: {}, safeHistory: [], annotations: [], animTime: 0, animating: false, teams: {} };
    const canvasV = document.getElementById('vector-layer');
    const ctxV = canvasV.getContext('2d');
    const canvasH = document.getElementById('heat-layer');
    const ctxH = canvasH.getContext('2d');
    const logos = {};

    for(let i=1; i<=12; i++) {
        state.history[i] = [];
        state.teams[i] = { name: `Time ${i}`, color: ['#FF0000','#00FF00','#0080FF','#FFFF00','#FF00FF','#00FFFF','#FFA500','#CC00FF','#00FF7F','#FFD700','#FF69B4','#40E0D0'][i-1] };
        document.getElementById('team-slot').add(new Option(state.teams[i].name, i));
    }

    document.getElementById('map-select').onchange = (e) => { if(e.target.value) document.getElementById('game-map').src = e.target.value; };
    document.getElementById('game-map').onload = resize;

    function resize() {
        const r = document.getElementById('game-map').getBoundingClientRect();
        canvasV.width = canvasH.width = r.width;
        canvasV.height = canvasH.height = r.height;
        render();
    }

    document.querySelectorAll('.btn-mode').forEach(b => {
        b.onclick = () => {
            state.mode = b.id.replace('mode-','');
            document.querySelectorAll('.btn-mode').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
        };
    });

    document.getElementById('interaction-layer').onclick = async (e) => {
        const r = e.target.getBoundingClientRect();
        const nx = (e.clientX - r.left) / r.width;
        const ny = (e.clientY - r.top) / r.height;

        if(state.mode === 'call' || state.mode === 'text') {
            const txt = prompt("Escreva a call deste ponto:");
            let imgData = null;
            if(state.mode === 'call' && txt) {
                const confirmImg = confirm("Deseja anexar uma imagem a este ponto verde?");
                if(confirmImg) {
                    const input = document.createElement('input');
                    input.type = 'file'; input.accept = 'image/*';
                    input.onchange = (ev) => {
                        const reader = new FileReader();
                        reader.onload = (f) => {
                            state.annotations.push({x:nx, y:ny, text:txt, img:f.target.result, type:'green'});
                            render();
                        };
                        reader.readAsDataURL(ev.target.files[0]);
                    };
                    input.click();
                    return;
                }
            }
            if(txt) state.annotations.push({x:nx, y:ny, text:txt, type: state.mode === 'call' ? 'green' : 'chat'});
        } else if(state.mode === 'safe') {
            state.safeHistory.push({x:nx, y:ny, r: parseInt(document.getElementById('global-size').value)/200});
        } else {
            const time = prompt("Minuto da chegada (ex: 4.5):", "0.0");
            state.history[document.getElementById('team-slot').value].push({x:nx, y:ny, t: parseFloat(time)});
        }
        render();
    };

    // Detec√ß√£o de clique nos √≠cones interativos
    document.getElementById('interaction-layer').onmousedown = (e) => {
        const r = e.target.getBoundingClientRect();
        const nx = (e.clientX - r.left) / r.width;
        const ny = (e.clientY - r.top) / r.height;

        state.annotations.forEach(ann => {
            const dist = Math.hypot(ann.x - nx, ann.y - ny);
            if(dist < 0.03) {
                const modal = document.getElementById('call-modal');
                document.getElementById('modal-desc').innerText = ann.text;
                const container = document.getElementById('modal-img-container');
                container.innerHTML = ann.img ? `<img src="${ann.img}">` : '';
                modal.style.display = 'block';
            }
        });
    };

    function drawHeat() {
        ctxH.clearRect(0,0,canvasH.width, canvasH.height);
        const opacity = document.getElementById('heat-opacity').value / 10;
        const radius = document.getElementById('heat-radius').value;
        if(opacity <= 0) return;
        ctxH.globalAlpha = opacity;
        Object.values(state.history).forEach(pts => {
            pts.forEach(p => {
                let g = ctxH.createRadialGradient(p.x*canvasH.width, p.y*canvasH.height, 0, p.x*canvasH.width, p.y*canvasH.height, radius);
                g.addColorStop(0, 'yellow'); g.addColorStop(0.5, 'orange'); g.addColorStop(1, 'transparent');
                ctxH.fillStyle = g; ctxH.beginPath(); ctxH.arc(p.x*canvasH.width, p.y*canvasH.height, radius, 0, Math.PI*2); ctxH.fill();
            });
        });
    }

    function drawVectors() {
        ctxV.clearRect(0,0,canvasV.width, canvasV.height);
        const w = canvasV.width, h = canvasV.height;

        // Safes
        state.safeHistory.forEach((s, i) => {
            ctxV.beginPath(); ctxV.strokeStyle = "white"; ctxV.setLineDash([5,5]);
            ctxV.arc(s.x*w, s.y*h, s.r*w, 0, Math.PI*2); ctxV.stroke();
        });
        ctxV.setLineDash([]);

        // Anota√ß√µes (Ponto Verde e Chat)
        state.annotations.forEach(ann => {
            ctxV.beginPath();
            if(ann.type === 'green') {
                ctxV.fillStyle = "#00FF00"; ctxV.shadowBlur = 15; ctxV.shadowColor = "#00FF00";
                ctxV.arc(ann.x*w, ann.y*h, 8, 0, Math.PI*2); ctxV.fill();
            } else {
                ctxV.fillStyle = "#0080FF"; ctxV.arc(ann.x*w, ann.y*h, 6, 0, Math.PI*2); ctxV.fill();
                ctxV.fillStyle = "white"; ctxV.font = "10px Arial"; ctxV.fillText("üí¨", ann.x*w-6, ann.y*h+4);
            }
            ctxV.shadowBlur = 0;
        });

        // Rotas com minutagem
        const lSize = parseInt(document.getElementById('global-size').value);
        Object.keys(state.history).forEach(id => {
            const pts = state.history[id];
            if(pts.length < 1) return;
            ctxV.beginPath(); ctxV.strokeStyle = state.teams[id].color; ctxV.lineWidth = 3;
            pts.forEach((p, i) => i === 0 ? ctxV.moveTo(p.x*w, p.y*h) : ctxV.lineTo(p.x*w, p.y*h));
            ctxV.stroke();

            const p = pts[pts.length-1];
            ctxV.fillStyle = "white"; ctxV.beginPath(); ctxV.arc(p.x*w, p.y*h, lSize, 0, Math.PI*2); ctxV.fill();
            if(logos[id]) ctxV.drawImage(logos[id], p.x*w - lSize, p.y*h - lSize, lSize*2, lSize*2);
            ctxV.fillStyle = "white"; ctxV.font = "bold 10px Arial";
            ctxV.fillText(`${p.t} min`, p.x*w - 15, p.y*h - lSize - 5);
        });
    }

    document.getElementById('undo-btn').onclick = () => {
        state.annotations.pop();
        state.safeHistory.pop();
        state.history[document.getElementById('team-slot').value].pop();
        render();
    };

    document.getElementById('up-logo').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image(); img.src = ev.target.result;
            img.onload = () => { logos[document.getElementById('team-slot').value] = img; render(); };
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function render() { drawHeat(); drawVectors(); }
</script>
</body>
</html>
