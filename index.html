<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>COACH LIPEE - TACTICAL V45 ULTRA</title>
    <style>
        :root { --neon: #00FF00; --bg: #050505; --card: #121214; --border: #2a2a2e; --red: #ff4d4d; --alert: #2ecc71; }
        body { background: var(--bg); margin: 0; font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; }
        
        #main-app { display: grid; grid-template-columns: 320px 1fr; height: 100vh; }
        
        /* Sidebar */
        #sidebar { background: var(--card); border-right: 1px solid var(--border); padding: 15px; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; z-index: 100; }
        .tool-card { background: #1c1c1f; border: 1px solid var(--border); border-radius: 8px; padding: 10px; }
        .tool-card h4 { margin: 0 0 8px 0; font-size: 10px; color: var(--neon); text-transform: uppercase; letter-spacing: 1px; }
        
        /* Controles */
        .btn { background: #252529; border: none; color: #a0a0a5; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: 900; transition: 0.2s; text-align: center; text-transform: uppercase; }
        .btn:hover { background: #303035; color: #fff; }
        .btn.active { background: var(--neon) !important; color: #000 !important; }
        .btn-alert.active { background: var(--alert) !important; color: #000 !important; }
        
        input, select, textarea { background: #0a0a0b; border: 1px solid var(--border); color: #fff; padding: 5px; border-radius: 4px; font-size: 11px; width: 100%; box-sizing: border-box; }
        
        /* Map Area */
        #viewport { position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #map-container { position: relative; line-height: 0; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        #game-map { max-width: 90vw; max-height: 80vh; display: block; filter: brightness(0.5); border-radius: 4px; }
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 50; pointer-events: all; }
        
        /* Modal */
        #alert-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #111; padding: 20px; border: 2px solid var(--alert); z-index: 200; 
            border-radius: 8px; width: 280px; box-shadow: 0 0 30px #000;
        }

        #timeline-bar { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            width: 60%; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 40px; 
            display: none; border: 1px solid var(--neon); z-index: 100; align-items: center; gap: 10px; 
        }
    </style>
</head>
<body>

<div id="alert-modal">
    <h3 style="color:var(--alert); margin:0 0 10px 0; font-size:14px;">‚ö†Ô∏è NOVO AVISO T√ÅTICO</h3>
    <textarea id="alert-text" placeholder="Ex: Cuidado com o guarita, Mina terrestre, etc..." rows="3"></textarea>
    <div style="display:flex; gap:5px; margin-top:10px;">
        <button class="btn" style="background:var(--alert); color:black; flex:1" id="save-alert">SALVAR</button>
        <button class="btn" style="background:#444; color:white; flex:1" onclick="closeModal()">CANCELAR</button>
    </div>
</div>

<div id="main-app">
    <div id="sidebar">
        <h2 style="color:var(--neon); margin:0; text-align: center; font-weight: 900; letter-spacing: -1px;">COACH LIPEE V45</h2>
        
        <div class="tool-card">
            <h4>üó∫Ô∏è MAPA</h4>
            <select id="map-select">
                <option value="https://i.imgur.com/8QOInU9.jpeg">Bermuda</option>
                <option value="https://i.imgur.com/R3t6f4D.jpeg">Purgat√≥rio</option>
                <option value="https://i.imgur.com/vH9Z3tM.jpeg">Alpine</option>
            </select>
        </div>

        <div class="tool-card">
            <h4>üî• MAPA DE CALOR</h4>
            <label style="font-size:9px">RAIO</label>
            <input type="range" id="heat-radius" min="10" max="150" value="40">
            <input type="range" id="heat-opacity" min="0.1" max="1.0" step="0.1" value="0.6" style="margin-top:5px">
        </div>

        <div class="tool-card">
            <h4>‚è±Ô∏è FERRAMENTAS</h4>
            <label style="font-size:9px">PR√ìXIMO MINUTO</label>
            <input type="number" id="manual-min" value="0" step="0.5" style="margin-bottom:8px">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px">
                <button class="btn btn-mode active" id="mode-route">ROTA</button>
                <button class="btn btn-mode" id="mode-safe">SAFE</button>
                <button class="btn btn-mode btn-alert" id="mode-alert" style="grid-column: span 2; border: 1px solid var(--alert); color: var(--alert);">‚ö†Ô∏è ADICIONAR AVISO</button>
            </div>
        </div>

        <button class="btn" id="play-btn" style="background:var(--neon); color:black; font-size:12px">‚ñ∂Ô∏è INICIAR REPLAY</button>
        <button class="btn" style="background:var(--red); color:white" onclick="location.reload()">üóëÔ∏è LIMPAR TUDO</button>

        <div class="tool-card" style="flex-grow: 1; margin-top: 10px;">
            <h4>üìã STATUS</h4>
            <div id="hud-stats" style="font-size:10px; line-height:1.6">
                PONTOS: <span id="st-pts">0</span><br>
                AVISOS: <span id="st-alerts">0</span><br>
                TEMPO TOTAL: <span id="st-time">0</span>m
            </div>
        </div>
    </div>

    <div id="viewport">
        <div id="map-container">
            <img id="game-map" src="https://i.imgur.com/8QOInU9.jpeg">
            <canvas id="heatmap-layer" class="layer"></canvas>
            <canvas id="vector-layer" class="layer"></canvas>
            <div id="interaction-layer"></div>
            <div id="marker" style="position:absolute; width:14px; height:14px; background:var(--neon); border-radius:50%; display:none; transform:translate(-50%,-50%); box-shadow:0 0 20px var(--neon); z-index:60; border:2px solid white;"></div>
        </div>

        <div id="timeline-bar">
            <span id="time-display" style="font-family:monospace; color:var(--neon); font-size:18px; font-weight:bold">00:00</span>
            <div style="color:white; font-size:10px; text-transform:uppercase">Minutos de Rota√ß√£o</div>
        </div>
    </div>
</div>

<script>
    const state = { points: [], safes: [], alerts: [], mode: 'route', mapLoaded: false, pendingCoord: null };
    const PALETTE = [[0,0,255], [0,104,55], [26,152,80], [166,217,106], [217,239,139], [254,224,139], [253,174,97], [244,109,67], [215,48,39], [165,0,38]];
    
    const img = document.getElementById('game-map');
    const cHeat = document.getElementById('heatmap-layer');
    const cVector = document.getElementById('vector-layer');
    const ctxHeat = cHeat.getContext('2d');
    const ctxVector = cVector.getContext('2d');
    const marker = document.getElementById('marker');

    function resize() {
        const rect = img.getBoundingClientRect();
        cHeat.width = cVector.width = rect.width;
        cHeat.height = cVector.height = rect.height;
        render();
    }
    img.onload = () => { state.mapLoaded = true; resize(); };
    window.onresize = resize;

    function render() {
        if(!state.mapLoaded) return;
        
        // 1. HEATMAP (Regra V36)
        const w = cHeat.width, h = cHeat.height;
        const radius = parseInt(document.getElementById('heat-radius').value);
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = w * 0.5; tempCanvas.height = h * 0.5;
        const tctx = tempCanvas.getContext('2d');
        tctx.fillStyle = "rgb(0,0,255)"; tctx.fillRect(0,0,tempCanvas.width,tempCanvas.height);
        tctx.globalCompositeOperation = "lighter";
        state.points.forEach(p => {
            let g = tctx.createRadialGradient(p.x*tempCanvas.width, p.y*tempCanvas.height, 0, p.x*tempCanvas.width, p.y*tempCanvas.height, radius/2);
            g.addColorStop(0, "rgba(255,255,255,0.5)"); g.addColorStop(1, "rgba(255,255,255,0)");
            tctx.fillStyle = g; tctx.beginPath(); tctx.arc(p.x*tempCanvas.width, p.y*tempCanvas.height, radius/2, 0, Math.PI*2); tctx.fill();
        });
        const d = tctx.getImageData(0,0,tempCanvas.width,tempCanvas.height);
        for(let i=0; i<d.data.length; i+=4) {
            const c = PALETTE[Math.min(9, Math.floor((d.data[i]/255)*12))] || PALETTE[0];
            d.data[i] = c[0]; d.data[i+1] = c[1]; d.data[i+2] = c[2];
        }
        tctx.putImageData(d, 0, 0);
        ctxHeat.clearRect(0,0,w,h);
        ctxHeat.globalAlpha = parseFloat(document.getElementById('heat-opacity').value);
        ctxHeat.drawImage(tempCanvas, 0, 0, w, h);

        // 2. VETORES E AVISOS (Regra V36)
        ctxVector.clearRect(0,0,w,h);
        
        // Linhas de Rota
        if(state.points.length > 1) {
            ctxVector.strokeStyle = "#00FF00"; ctxVector.lineWidth = 2; ctxVector.setLineDash([5, 3]);
            ctxVector.beginPath();
            state.points.forEach((p, i) => {
                if(i === 0) ctxVector.moveTo(p.x*w, p.y*h); else ctxVector.lineTo(p.x*w, p.y*h);
            });
            ctxVector.stroke(); ctxVector.setLineDash([]);
        }

        // Pontos e Minutos
        state.points.forEach(p => {
            ctxVector.fillStyle = "#00FF00"; ctxVector.beginPath(); ctxVector.arc(p.x*w, p.y*h, 3, 0, Math.PI*2); ctxVector.fill();
            ctxVector.fillStyle = "white"; ctxVector.font = "bold 10px Arial";
            ctxVector.fillText(p.time + "m", p.x*w + 5, p.y*h - 5);
        });

        // Avisos (Bolinha Verde V36)
        state.alerts.forEach(a => {
            ctxVector.fillStyle = "#2ecc71"; ctxVector.beginPath(); ctxVector.arc(a.x*w, a.y*h, 10, 0, Math.PI*2); ctxVector.fill();
            ctxVector.fillStyle = "black"; ctxVector.font = "bold 12px Arial"; ctxVector.textAlign = "center";
            ctxVector.fillText("!", a.x*w, a.y*h + 4);
            ctxVector.fillStyle = "white"; ctxVector.font = "9px Arial";
            ctxVector.fillText(a.text, a.x*w, a.y*h + 20);
            ctxVector.textAlign = "left";
        });

        // Safes
        state.safes.forEach(s => {
            ctxVector.strokeStyle = "white"; ctxVector.lineWidth = 2;
            ctxVector.beginPath(); ctxVector.arc(s.x*w, s.y*h, 45, 0, Math.PI*2); ctxVector.stroke();
        });

        // Atualizar HUD
        document.getElementById('st-pts').innerText = state.points.length;
        document.getElementById('st-alerts').innerText = state.alerts.length;
        document.getElementById('st-time').innerText = state.points.length ? state.points[state.points.length-1].time : 0;
    }

    document.getElementById('interaction-layer').onclick = (e) => {
        const rect = img.getBoundingClientRect();
        const nx = (e.clientX - rect.left) / rect.width;
        const ny = (e.clientY - rect.top) / rect.height;

        if(state.mode === 'route') {
            const t = parseFloat(document.getElementById('manual-min').value);
            state.points.push({x: nx, y: ny, time: t});
            document.getElementById('manual-min').value = t + 0.5;
        } else if(state.mode === 'safe') {
            state.safes.push({x: nx, y: ny});
        } else if(state.mode === 'alert') {
            state.pendingCoord = {x: nx, y: ny};
            document.getElementById('alert-modal').style.display = 'block';
        }
        render();
    };

    document.getElementById('save-alert').onclick = () => {
        const txt = document.getElementById('alert-text').value;
        if(txt) {
            state.alerts.push({...state.pendingCoord, text: txt});
            closeModal();
            render();
        }
    };

    function closeModal() { 
        document.getElementById('alert-modal').style.display = 'none'; 
        document.getElementById('alert-text').value = '';
    }

    document.getElementById('play-btn').onclick = () => {
        if(state.points.length < 2) return;
        marker.style.display = 'block';
        document.getElementById('timeline-bar').style.display = 'flex';
        const totalMin = state.points[state.points.length-1].time;
        const start = performance.now();

        function frame() {
            const elapsed = (performance.now() - start) / 1000; 
            if(elapsed > totalMin) {
                document.getElementById('timeline-bar').style.display = 'none';
                marker.style.display = 'none';
                return;
            }

            for(let i=0; i<state.points.length-1; i++) {
                const p1 = state.points[i], p2 = state.points[i+1];
                if(elapsed >= p1.time && elapsed <= p2.time) {
                    const pct = (elapsed - p1.time) / (p2.time - p1.time);
                    marker.style.left = ((p1.x + (p2.x - p1.x) * pct) * img.clientWidth) + "px";
                    marker.style.top = ((p1.y + (p2.y - p1.y) * pct) * img.clientHeight) + "px";
                    document.getElementById('time-display').innerText = Math.floor(elapsed) + "m" + Math.floor((elapsed%1)*60).toString().padStart(2,'0') + "s";
                }
            }
            requestAnimationFrame(frame);
        }
        frame();
    };

    // UI Switches
    const setMode = (m, btnId) => {
        state.mode = m;
        document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
        document.getElementById(btnId).classList.add('active');
    };
    document.getElementById('mode-route').onclick = () => setMode('route', 'mode-route');
    document.getElementById('mode-safe').onclick = () => setMode('safe', 'mode-safe');
    document.getElementById('mode-alert').onclick = () => setMode('alert', 'mode-alert');
    document.getElementById('heat-radius').oninput = render;
    document.getElementById('heat-opacity').oninput = render;
    document.getElementById('map-select').onchange = (e) => img.src = e.target.value;
</script>
</body>
</html>
