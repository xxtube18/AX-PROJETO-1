<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COACH LIPEE - MANUAL TIME V36 PRO</title>
    <style>
        :root { --neon-green: #00FF00; --alert-green: #2ecc71; --dark-bg: #050505; --panel-bg: rgba(15, 15, 15, 0.98); }
        body { background: var(--dark-bg); margin: 0; font-family: 'Segoe UI', sans-serif; color: white; overflow: hidden; }
        
        #controls-panel {
            background: var(--panel-bg); padding: 10px; display: flex; flex-wrap: wrap; gap: 10px; 
            justify-content: center; align-items: center; border-bottom: 2px solid #333; z-index: 100;
        }

        .control-group { background: #1a1a1a; padding: 6px 12px; border-radius: 6px; border: 1px solid #333; display: flex; align-items: center; gap: 8px; }
        label { font-weight: bold; color: var(--neon-green); font-size: 10px; text-transform: uppercase; }
        input[type=range] { accent-color: var(--neon-green); width: 70px; }
        
        .action-btn { padding: 8px 15px; border-radius: 4px; border: none; font-weight: 900; cursor: pointer; font-size: 10px; text-transform: uppercase; transition: 0.2s; }
        .btn-safe { background: #f1c40f; color: #000; }
        .btn-alert { background: var(--alert-green); color: #000; }
        .btn-view { background: #3498db; color: #fff; }
        .btn-time { background: #e74c3c; color: #fff; }
        .btn-anim { background: #9b59b6; color: #fff; box-shadow: 0 0 10px #9b59b6; }
        .btn-save { background: #2ecc71; color: #000; }

        #viewport { position: relative; width: 100vw; height: calc(100vh - 80px); display: flex; justify-content: center; align-items: center; background: #000; }
        #map-container { position: relative; display: inline-block; }
        #game-map { max-width: 98vw; max-height: 80vh; display: block; filter: brightness(60%) contrast(1.1); }
        
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #heatmap-layer { z-index: 5; mix-blend-mode: screen; }
        #vector-layer { z-index: 10; }
        #interaction-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 50; pointer-events: all; }

        /* MODAL DE AVISO */
        #alert-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #111; padding: 20px; border: 2px solid var(--alert-green); z-index: 200; 
            border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.8); width: 300px;
        }
        #alert-modal textarea { width: 100%; background: #222; color: #fff; border: 1px solid #444; padding: 10px; box-sizing: border-box; margin: 10px 0; }

        #hud { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 4px; border-left: 4px solid var(--neon-green); font-size: 11px; z-index: 60; pointer-events: none; }
        .input-dark { background:#222; color:#fff; border:1px solid #444; padding: 2px; }
    </style>
</head>
<body>

    <div id="controls-panel">
        <div class="control-group"><label>üìÇ MAPA</label><input type="file" id="up-map" accept="image/*"></div>
        <div class="control-group"><label>üåë BRILHO</label><input type="range" id="map-bright" min="10" max="100" value="60"></div>
        
        <div class="control-group">
            <label>SLOT</label><select id="team-slot" class="input-dark"></select>
            <input type="text" id="manual-min" placeholder="Min" style="width:35px;" class="input-dark">
        </div>
        
        <div class="control-group">
            <button class="action-btn btn-safe" id="mode-safe">SAFE: OFF</button>
            <button class="action-btn btn-alert" id="mode-alert">‚ö†Ô∏è AVISO: OFF</button>
            <button class="action-btn btn-view" id="toggle-vectors">üëÅÔ∏è VER</button>
        </div>

        <div style="display: flex; gap: 6px;">
            <button class="action-btn btn-anim" id="start-replay">‚ñ∂Ô∏è REPLAY</button>
            <button class="action-btn btn-save" id="export-btn">üíæ SALVAR</button>
            <button class="action-btn" style="background:#444; color:#fff" onclick="location.reload()">üóëÔ∏è RESET</button>
        </div>
    </div>

    <div id="alert-modal">
        <h3 style="color:var(--alert-green); margin:0; font-size:14px;">NOVO AVISO NO MAPA</h3>
        <textarea id="alert-text" rows="3" placeholder="O que aconteceu aqui?"></textarea>
        <label style="font-size:10px; display:block; margin-bottom:5px;">UPLOAD FOTO/V√çDEO:</label>
        <input type="file" id="alert-media" accept="image/*,video/*" style="font-size:10px; color:white; margin-bottom:15px;">
        <div style="display:flex; gap:10px;">
            <button class="action-btn btn-save" id="save-alert-btn" style="flex:1">SALVAR</button>
            <button class="action-btn" style="background:#444; color:#fff; flex:1" id="cancel-alert-btn">SAIR</button>
        </div>
    </div>

    <div id="viewport">
        <div id="map-container">
            <img id="game-map" src="">
            <canvas id="heatmap-layer" class="layer"></canvas>
            <canvas id="vector-layer" class="layer"></canvas>
            <div id="interaction-layer"></div>
        </div>
        <div id="hud">STATUS: <span id="hud-mode" style="color:var(--neon-green)">ROTA√á√ÉO</span><br>AVISOS: <span id="hud-alerts">0</span> | PONTOS: <span id="hud-pts">0</span></div>
    </div>

    <script>
        const state = { 
            mapLoaded: false, safeMode: false, alertMode: false, showVectors: true, showTimer: true, 
            activeSlot: 1, animating: false, teams: {}, history: {}, safeHistory: [], alerts: [], animStart: 0 
        };
        const logos = {};
        const canvases = { heat: document.getElementById('heatmap-layer'), vector: document.getElementById('vector-layer') };
        const ctxs = { heat: canvases.heat.getContext('2d'), vector: canvases.vector.getContext('2d') };
        let pendingCoord = null;

        for(let i=1; i<=12; i++) {
            state.teams[i] = { tag: `T${i}`, color: getTeamColor(i) };
            state.history[i] = [];
            document.getElementById('team-slot').add(new Option(`Slot ${i}`, i));
        }

        function getTeamColor(i) { return ['#FF0000', '#00FF00', '#0080FF', '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#CC00FF', '#00FF7F', '#FFD700', '#FF69B4', '#40E0D0'][i-1]; }

        document.getElementById('up-map').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => { 
                document.getElementById('game-map').src = ev.target.result; 
                document.getElementById('game-map').onload = () => { state.mapLoaded = true; resize(); }; 
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function resize() {
            const rect = document.getElementById('game-map').getBoundingClientRect();
            canvases.heat.width = canvases.vector.width = rect.width;
            canvases.heat.height = canvases.vector.height = rect.height;
            render();
        }

        document.getElementById('interaction-layer').onmousedown = (e) => {
            if(!state.mapLoaded) return;
            const rect = e.target.getBoundingClientRect();
            const nx = (e.clientX - rect.left) / rect.width;
            const ny = (e.clientY - rect.top) / rect.height;

            if(state.alertMode) {
                pendingCoord = { x: nx, y: ny };
                document.getElementById('alert-modal').style.display = 'block';
            } else if(state.safeMode) {
                state.safeHistory.push({ x: nx, y: ny, r: 0.25 });
                render();
            } else {
                const manualMin = document.getElementById('manual-min').value || "0";
                state.history[state.activeSlot].push({ x: nx, y: ny, time: manualMin });
                render();
            }
            updateHUD();
        };

        // Salvar Alerta
        document.getElementById('save-alert-btn').onclick = () => {
            const text = document.getElementById('alert-text').value;
            const file = document.getElementById('alert-media').files[0];
            
            const newAlert = { ...pendingCoord, text: text, media: null, type: null };
            
            if(file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    newAlert.media = ev.target.result;
                    newAlert.type = file.type;
                    state.alerts.push(newAlert);
                    finalizeAlert();
                };
                reader.readAsDataURL(file);
            } else {
                state.alerts.push(newAlert);
                finalizeAlert();
            }
        };

        function finalizeAlert() {
            document.getElementById('alert-modal').style.display = 'none';
            document.getElementById('alert-text').value = '';
            document.getElementById('alert-media').value = '';
            updateHUD();
            render();
        }

        document.getElementById('cancel-alert-btn').onclick = () => document.getElementById('alert-modal').style.display = 'none';

        function drawVectors(animTeams = null, animSafe = null) {
            const w = canvases.vector.width, h = canvases.vector.height;
            ctxs.vector.clearRect(0,0,w,h);
            if(!state.showVectors || w === 0) return;

            // Safe
            const safe = animSafe || (state.safeHistory.length > 0 ? state.safeHistory[state.safeHistory.length - 1] : null);
            if(safe) {
                ctxs.vector.beginPath(); ctxs.vector.setLineDash([10, 5]); ctxs.vector.strokeStyle = "white"; 
                ctxs.vector.arc(safe.x*w, safe.y*h, safe.r*w, 0, Math.PI*2); ctxs.vector.stroke(); ctxs.vector.setLineDash([]);
            }

            // Alertas Verdes
            state.alerts.forEach(alert => {
                ctxs.vector.fillStyle = "#2ecc71";
                ctxs.vector.beginPath(); ctxs.vector.arc(alert.x*w, alert.y*h, 10, 0, Math.PI*2); ctxs.vector.fill();
                ctxs.vector.fillStyle = "black"; ctxs.vector.font = "bold 12px Arial"; ctxs.vector.textAlign = "center";
                ctxs.vector.fillText("!", alert.x*w, alert.y*h + 4);
                ctxs.vector.fillStyle = "white"; ctxs.vector.font = "9px Arial";
                ctxs.vector.fillText(alert.text.substring(0, 15), alert.x*w, alert.y*h + 20);
            });

            // Rotas dos Times
            Object.keys(state.history).forEach(id => {
                const hist = state.history[id], team = state.teams[id];
                if(hist.length === 0) return;
                ctxs.vector.beginPath(); ctxs.vector.strokeStyle = team.color; ctxs.vector.lineWidth = 2;
                hist.forEach((p, i) => i===0 ? ctxs.vector.moveTo(p.x*w,p.y*h) : ctxs.vector.lineTo(p.x*w,p.y*h));
                ctxs.vector.stroke();
                const pos = hist[hist.length-1];
                ctxs.vector.fillStyle = team.color; ctxs.vector.beginPath(); ctxs.vector.arc(pos.x*w, pos.y*h, 6, 0, Math.PI*2); ctxs.vector.fill();
            });
        }

        function render() { drawVectors(); }

        // Alternadores de Modo
        document.getElementById('mode-safe').onclick = () => {
            state.safeMode = !state.safeMode; state.alertMode = false;
            document.getElementById('mode-safe').innerText = state.safeMode ? "SAFE: ON" : "SAFE: OFF";
            document.getElementById('mode-alert').innerText = "‚ö†Ô∏è AVISO: OFF";
        };

        document.getElementById('mode-alert').onclick = () => {
            state.alertMode = !state.alertMode; state.safeMode = false;
            document.getElementById('mode-alert').innerText = state.alertMode ? "AVISO: ON" : "AVISO: OFF";
            document.getElementById('mode-safe').innerText = "SAFE: OFF";
        };

        function updateHUD() { 
            document.getElementById('hud-pts').innerText = state.history[state.activeSlot].length; 
            document.getElementById('hud-alerts').innerText = state.alerts.length; 
        }

        window.onresize = resize;
        document.getElementById('export-btn').onclick = () => {
            const data = JSON.stringify(state);
            const blob = new Blob([data], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `rota-v36-completa.json`; a.click();
        };
    </script>
</body>
</html>
